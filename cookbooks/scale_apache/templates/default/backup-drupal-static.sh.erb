#!/bin/bash

BUCKET="scale-drupal-backups"
TMPFILE=`mktemp -d`
DATE=`date +%Y/%m/%d`
TIME=`date +%H-%M-%S`
TARGET="drupal-static_${HOSTNAME}_${TIME}.tar.gz"

S3KEY="AKIAJFKLHCWBTGAYBUYQ"
S3SECRET="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"

echo "Starting backup...."
tar cfz $TMPFILE/${TARGET} -C /home/drupal/scale-drupal/httpdocs/sites/default/ files

echo "Uploading backup...."
s3put --access_key ${S3KEY} --secret_key ${S3SECRET} --bucket ${BUCKET} --prefix ${TMPFILE} --key_prefix static/$DATE/ ${TMPFILE}/${TARGET}

if [ $? -eq 0 ]; then
  rm "${TMPFILE}/${TARGET}"
  rmdir "${TMPFILE}"
fi
